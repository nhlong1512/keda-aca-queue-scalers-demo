name: Build and deploy Apps to ACR

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/apps.yml"
      - "src/Apps/**"
  workflow_dispatch:
    

env:
  SUBSCRIPTIONID: c38893c4-15b8-4925-bad8-f5486addcc7d
  RESOURCEGROUP: Demo
  ACR: ramardeni

jobs:
  build:
    name: Build Apps
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master

    - name: Azure authentication
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ACR Build Producer
      run: |
        cd src/Apps/ServiceBus/ServiceBusQueueProducer
        az acr build --image ServiceBus/ServiceBusQueueProducer:$GITHUB_SHA \
          --registry $ACR \
          --file Dockerfile .

    - name: ACR Build Reader
      run: |
        cd src/Apps/ServiceBus/ServiceBusQueueReader
        az acr build --image ServiceBus/ServiceBusQueueReader:$GITHUB_SHA \
          --registry $ACR \
          --file Dockerfile .

